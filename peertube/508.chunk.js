(globalThis.webpackChunkpeertube_client=globalThis.webpackChunkpeertube_client||[]).push([[508,470],{9435:(t,e,s)=>{"use strict";s.r(e),s.d(e,{P2pMediaLoaderPlugin:()=>g});var i,r=s(3654),o=s.n(r),n=s(7382),a=s(1819),l=s(2088),h=s(4538),d=s.n(h),p=s(5168);class u{constructor(t,e,s){this.errorCounts={},this.maxNetworkErrorRecovery=5,this.hlsjsConfig=null,this._duration=null,this.metadata=null,this.isLive=null,this.dvrDuration=null,this.edgeMargin=null,this.handlers={play:null},this.vjs=t,this.source=e,this.tech=s,this.tech.name_="Hlsjs",this.videoElement=s.el(),this.player=t(s.options_.playerId),this.videoElement.addEventListener("error",(t=>{let e;const s=(t.currentTarget||t.target).error;if(s){switch(p.k.info(s),s.code){case s.MEDIA_ERR_ABORTED:e="You aborted the video playback";break;case s.MEDIA_ERR_DECODE:e="The video playback was aborted due to a corruption problem or because the video used features your browser did not support",this._handleMediaError(s);break;case s.MEDIA_ERR_NETWORK:e="A network error caused the video download to fail part-way";break;case s.MEDIA_ERR_SRC_NOT_SUPPORTED:e="The video could not be loaded, either because the server or network failed or because the format is not supported";break;default:e=s.message}p.k.error(`MEDIA_ERROR: ${e}`)}})),this.initialize()}duration(){return this._duration===1/0?1/0:isNaN(this.videoElement.duration)?this._duration||0:this.videoElement.duration}seekable(){if(this.hls.media){if(!this.isLive)return this.vjs.createTimeRanges(0,this.hls.media.duration);const t=Math.round(this.hls.media.duration-this.dvrDuration),e=Math.round(this.hls.media.duration-this.edgeMargin);return this.vjs.createTimeRanges(t,e)}return this.vjs.createTimeRanges()}dispose(){this.videoElement.removeEventListener("play",this.handlers.play);const t=this.hls;t.log=t.warn=()=>{},this.hls.destroy()}static addHook(t,e){u.hooks[t]=this.hooks[t]||[],u.hooks[t].push(e)}static removeHook(t,e){if(void 0===u.hooks[t])return!1;const s=u.hooks[t].indexOf(e);return-1!==s&&(u.hooks[t].splice(s,1),!0)}_executeHooksFor(t){if(void 0!==u.hooks[t])for(let e=0;e<u.hooks[t].length;e++)u.hooks[t][e](this.player,this.hls)}_handleMediaError(t){return 1===this.errorCounts[d().ErrorTypes.MEDIA_ERROR]?(p.k.info("trying to recover media error"),void this.hls.recoverMediaError()):2===this.errorCounts[d().ErrorTypes.MEDIA_ERROR]?(p.k.info("2nd try to recover media error (by swapping audio codec"),this.hls.swapAudioCodec(),void this.hls.recoverMediaError()):void(this.errorCounts[d().ErrorTypes.MEDIA_ERROR]>2&&(p.k.info("bubbling media error up to VIDEOJS"),this.hls.destroy(),this.tech.error=()=>t,this.tech.trigger("error")))}_handleNetworkError(t){if(this.errorCounts[d().ErrorTypes.NETWORK_ERROR]<=this.maxNetworkErrorRecovery)return p.k.info("trying to recover network error"),setTimeout((()=>this.hls.startLoad()),1e3),void this.hls.once(d().Events.FRAG_LOADED,(()=>{this.errorCounts[d().ErrorTypes.NETWORK_ERROR]=0}));p.k.info("bubbling network error up to VIDEOJS"),this.hls.destroy(),this.tech.error=()=>t,this.tech.trigger("error")}_onError(t,e){const s={message:`HLS.js error: ${e.type} - fatal: ${e.fatal} - ${e.details}`};this.errorCounts[e.type]?this.errorCounts[e.type]+=1:this.errorCounts[e.type]=1,e.fatal?p.k.warn(s.message):p.k.error(s.message,{data:e}),e.type===d().ErrorTypes.NETWORK_ERROR?(s.code=2,this._handleNetworkError(s)):e.fatal&&e.type===d().ErrorTypes.MEDIA_ERROR&&"manifestIncompatibleCodecsError"!==e.details?(s.code=3,this._handleMediaError(s)):e.fatal&&(this.hls.destroy(),p.k.info("bubbling error up to VIDEOJS"),this.tech.error=()=>s,this.tech.trigger("error"))}buildLevelLabel(t){return this.player.srOptions_.levelLabelHandler?this.player.srOptions_.levelLabelHandler(t):t.height?t.height+"p":t.width?Math.round(9*t.width/16)+"p":t.bitrate?t.bitrate/1e3+"kbps":"0"}_notifyVideoQualities(){if(!this.metadata)return;const t=[];this.metadata.levels.forEach(((e,s)=>{t.push({id:s,height:e.height,width:e.width,bitrate:e.bitrate,label:this.buildLevelLabel(e),selected:e.id===this.hls.manualLevel,selectCallback:()=>{this.hls.currentLevel=s}})})),t.push({id:-1,label:this.player.localize("Auto"),selected:!0,selectCallback:()=>this.hls.currentLevel=-1}),this.player.peertubeResolutions().add(t)}_startLoad(){this.hls.startLoad(-1),this.videoElement.removeEventListener("play",this.handlers.play)}_oneLevelObjClone(t){const e={},s=Object.keys(t);for(let i=0;i<s.length;i++)e[s[i]]=t[s[i]];return e}_onMetaData(t,e){this.metadata=e,this._notifyVideoQualities()}_initHlsjs(){const t=this.player.srOptions_,e=(null==t?void 0:t.hlsjsConfig)||this.tech.options_.hlsjsConfig;this.hlsjsConfig=e?this._oneLevelObjClone(e):{},["","auto"].includes(this.videoElement.preload)&&!this.videoElement.autoplay&&void 0===this.hlsjsConfig.autoStartLoad&&(this.hlsjsConfig.autoStartLoad=!1),!1===this.hlsjsConfig.autoStartLoad&&(this.handlers.play=this._startLoad.bind(this),this.videoElement.addEventListener("play",this.handlers.play)),this.hls=new(d())(this.hlsjsConfig),this._executeHooksFor("beforeinitialize"),this.hls.on(d().Events.ERROR,((t,e)=>this._onError(t,e))),this.hls.on(d().Events.MANIFEST_PARSED,((t,e)=>this._onMetaData(t,e))),this.hls.on(d().Events.LEVEL_LOADED,((t,e)=>{this.hlsjsConfig.liveSyncDuration?this.edgeMargin=this.hlsjsConfig.liveSyncDuration:this.hlsjsConfig.liveSyncDurationCount&&(this.edgeMargin=this.hlsjsConfig.liveSyncDurationCount*e.details.targetduration),this.isLive=e.details.live,this.dvrDuration=e.details.totalduration,this._duration=this.isLive?1/0:e.details.totalduration,this.isLive&&(this.maxNetworkErrorRecovery=300)})),this.hls.once(d().Events.FRAG_LOADED,(()=>{this.tech.trigger("loadedmetadata")})),this.hls.on(d().Events.LEVEL_SWITCHING,((t,e)=>{const s=this.hls.autoLevelEnabled?-1:e.level,i=this.hls.autoLevelEnabled?e.level:-1;this.player.peertubeResolutions().select({id:s,autoResolutionChosenId:i,byEngine:!0})})),this.hls.attachMedia(this.videoElement),this.hls.loadSource(this.source.src)}initialize(){this._initHlsjs()}}u.hooks={},((i=o()).registerPlugin||i.plugin)("hlsjs",(function(t){const e=this;t&&(e.srOptions_||(e.srOptions_={}),e.srOptions_.hlsjsConfig||(e.srOptions_.hlsjsConfig=t.hlsjsConfig),t.levelLabelHandler&&!e.srOptions_.levelLabelHandler&&(e.srOptions_.levelLabelHandler=t.levelLabelHandler))})),function(t){if(!d().isSupported())return void p.k.warn("Hls.js is not supported in this browser!");const e=t.getTech("Html5");e?(e.registerSourceHandler({canHandleSource:function(t){return/^application\/x-mpegURL|application\/vnd\.apple\.mpegurl$/i.test(t.type)?"probably":/\.m3u8/i.test(t.src)?"maybe":""},handleSource:function(e,s){return s.hlsProvider&&s.hlsProvider.dispose(),s.hlsProvider=new u(t,e,s),s.hlsProvider}},0),t.Html5Hlsjs=u):p.k.error("No Hml5 tech found in videojs")}(o());const c=o().getPlugin("plugin");class g extends c{constructor(t,e){if(super(t),this.CONSTANTS={INFO_SCHEDULER:1e3},this.statsP2PBytes={pendingDownload:[],pendingUpload:[],numPeers:0,totalDownload:0,totalUpload:0},this.statsHTTPBytes={pendingDownload:[],pendingUpload:[],totalDownload:0,totalUpload:0},this.options=e,o().Html5Hlsjs)o().Html5Hlsjs.addHook("beforeinitialize",((t,e)=>{this.hlsjs=e})),(0,a.initVideoJsContribHlsJsPlayer)(t);else if(p.k.warn("HLS.js does not seem to be supported. Try to fallback to built in HLS."),!t.canPlayType("application/vnd.apple.mpegurl")){const e="Cannot fallback to built-in HLS";return p.k.warn(e),void t.ready((()=>t.trigger("error",new Error(e))))}this.startTime=(0,l.h8)(e.startTime),t.src({type:e.type,src:e.src}),t.ready((()=>{this.initializeCore(),o().Html5Hlsjs&&this.initializePlugin()}))}dispose(){this.hlsjs&&this.hlsjs.destroy(),this.p2pEngine&&this.p2pEngine.destroy(),clearInterval(this.networkInfoInterval)}getCurrentLevel(){return this.hlsjs.levels[this.hlsjs.currentLevel]}getLiveLatency(){return Math.round(this.hlsjs.latency)}getHLSJS(){return this.hlsjs}initializeCore(){this.player.one("play",(()=>{this.player.addClass("vjs-has-big-play-button-clicked")})),this.player.one("canplay",(()=>{this.startTime&&this.player.currentTime(this.startTime)}))}initializePlugin(){(0,a.initHlsJsPlayer)(this.hlsjs),this.p2pEngine=this.options.loader.getEngine(),this.p2pEngine.on(n.Events.SegmentError,((t,e)=>{p.k.error(`Segment ${t.id} error.`,e),this.options.redundancyUrlManager.removeBySegmentUrl(t.requestUrl)})),this.statsP2PBytes.numPeers=1+this.options.redundancyUrlManager.countBaseUrls(),this.runStats()}runStats(){this.p2pEngine.on(n.Events.PieceBytesDownloaded,((t,e,s)=>{const i="p2p"===t?this.statsP2PBytes:this.statsHTTPBytes;i.pendingDownload.push(s),i.totalDownload+=s})),this.p2pEngine.on(n.Events.PieceBytesUploaded,((t,e,s)=>{const i="p2p"===t?this.statsP2PBytes:this.statsHTTPBytes;i.pendingUpload.push(s),i.totalUpload+=s})),this.p2pEngine.on(n.Events.PeerConnect,(()=>this.statsP2PBytes.numPeers++)),this.p2pEngine.on(n.Events.PeerClose,(()=>this.statsP2PBytes.numPeers--)),this.networkInfoInterval=setInterval((()=>{const t=this.arraySum(this.statsP2PBytes.pendingDownload),e=this.arraySum(this.statsP2PBytes.pendingUpload),s=this.arraySum(this.statsHTTPBytes.pendingDownload),i=this.arraySum(this.statsHTTPBytes.pendingUpload);return this.statsP2PBytes.pendingDownload=[],this.statsP2PBytes.pendingUpload=[],this.statsHTTPBytes.pendingDownload=[],this.statsHTTPBytes.pendingUpload=[],this.player.trigger("p2pInfo",{source:"p2p-media-loader",http:{downloadSpeed:s,uploadSpeed:i,downloaded:this.statsHTTPBytes.totalDownload,uploaded:this.statsHTTPBytes.totalUpload},p2p:{downloadSpeed:t,uploadSpeed:e,numPeers:this.statsP2PBytes.numPeers,downloaded:this.statsP2PBytes.totalDownload,uploaded:this.statsP2PBytes.totalUpload},bandwidthEstimate:this.hlsjs.bandwidthEstimate/8})}),this.CONSTANTS.INFO_SCHEDULER)}arraySum(t){return t.reduce(((t,e)=>t+e),0)}}o().registerPlugin("p2pMediaLoader",g)},9354:()=>{},3762:()=>{},8333:()=>{},59:()=>{},2361:()=>{},4616:()=>{},3719:()=>{}}]);
//# sourceMappingURL=508.chunk.js.map